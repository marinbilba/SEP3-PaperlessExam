@page "/MultipleChoiceQuestions"
@page "/asdffads"
@using System.Reflection.Metadata
@using Microsoft.AspNetCore.Razor.TagHelpers
@using SEP3.PaperlessExam.Data.PaperlessExamSevice
@using SEP3.PaperlessExam.Data.PaperlessExamSevice.QuestionSetsService
@using SEP3.PaperlessExam.Model
@using SEP3.PaperlessExam.Model.Questions.MultipleChoice
@inject IJSRuntime JsRuntime
@inject IUserService UserService
@inject IQuestionSetsService QuestionSetsService
@inject NavigationManager NavigationManager
@inject IToastService toastService

<h3 xmlns="">MultipleChoiceQuestions</h3>

<link rel="stylesheet" type="text/css" href="css/TeacherView/QuestionManagement/CreateQuestionSet/MultipleChoice/multipleChoiceQuestions.css">

<h3>Multiple-choice Questions Builder</h3>

@if (_multipleChoiceSet != null)
{
<EditForm Model="_multipleChoiceSet">

    @for (var _index1 = 0; _index1 < _multipleChoiceSet.MultipleChoiceQuestions.Count; _index1++)
    {
        var multipleChoiceQuestion = _multipleChoiceSet.MultipleChoiceQuestions[_index1];
        _counter = _index1 + 1;
        <div class="container-fluid questionContainer">
            @* Type question  *@
            <div class="row">
                <div class="col-md-1">
                    <div class="questionNumberBox d-flex">
                        <div class="d-flex">
                            <p class="questionNumber">@_counter</p>
                            @* <input style="width: 33px; text-align: right;" type="number" placeholder="@_counter" @bind-value="multipleChoiceQuestion.QuestionNumber"> *@
                        </div>
                    </div>
                </div>
                <div class="col-md-11">
                    <InputText type="text" class="form-control" placeholder="Type your question" @bind-Value="multipleChoiceQuestion.question"></InputText>
                </div>
            </div>
            @* Type number of points *@
            <div class="row top-buffer">
                <div class="col-md-1 offset-1  padding-right0 ">
                    <input type="number" class="form-control" @bind-value="multipleChoiceQuestion.Score" placeholder="Score"/>
                </div>
                <div class="col-md-1 padding-left0">
                    <label>points</label>
                </div>
            </div>


            <div class="row top-buffer justify-content-center">
                <div class="col-md-1 offset-2">
                </div>
                <div class="col-md-7">
                </div>
                <div class="col-md-1"></div>
            </div>


            @for (var i = 0; i < multipleChoiceQuestion.QuestionOptions.Count; i++)
            {
                var questionOption = multipleChoiceQuestion.QuestionOptions[i];
                Console.WriteLine(i);
                <div class="form-group row top-buffer justify-content-center">
                    <div class="col-md-1 offset-2">
                        <RadzenCheckBox Style="width: 36px;height: 34px" TValue="bool" @bind-Value="@questionOption.CorrectAnswer" Change=@(args => SetCorrectAnswer(args))>
                        </RadzenCheckBox>

                    </div>
                    <div class="col-md-7">
                        <InputText type="text" class="form-control" @bind-Value="@questionOption.Answer" placeholder="Answer"/>
                    </div>
                    <div class="col-md-1">
                        <RadzenButton Icon="delete" style="width: 37px" Click=@(() => multipleChoiceQuestion.RemoveQuestionOption(questionOption))>
                        </RadzenButton>
                    </div>
                </div>
            }
            <div class="row top-buffer justify-content-center">
                <div class="col-md-1 offset-2">
                    <div class="additionalQuestionSelectBox">
                    </div>
                </div>
                <div class="col-md-8">
                    <button id="addButton" type="button" class="additionalQuestionButton"
                            @onclick="@(() => multipleChoiceQuestion.AddQuestionOption(new QuestionOption()))">
                        <span style="color: blue"> Add more</span>
                    </button>
                </div>
            </div>


            @* Add additional option *@

        </div>
    }

</EditForm>


}
    @* Add new question && Finish buttons *@
    <div class="row top-buffer justify-content-between">
        <div class="col-md-3 offset-9">
            <RadzenButton Icon="" Text="Add question" Click=@(() => done())></RadzenButton>
            <RadzenButton Disabled="@_disable" style="width: auto; margin-right: 7px" Icon="delete" Click=@(() => delete())>
            </RadzenButton>
            <RadzenButton Icon="" style="background-color: #3eb02f;margin-top: 5px" Text="Finish">
            </RadzenButton>

        </div>

        @* <div class="col-md-3"> *@
        @*    *@
        @* </div> *@
    </div>

@code {

    [Parameter]
    public string Username { get; set; }

    [Parameter]
    public string Title { get; set; }

    [Parameter]
    public string Topic { get; set; }


    private User _updatedUser;

    private string _roleName;

    private string _score;

    private string _question;

    private int _counter;

    private int _stepper;

    private bool _disable;


    private MultipleChoiceSet _multipleChoiceSet;


    protected override async Task OnInitializedAsync()
    {
        var user=new User();
        try
        {
            user= await UserService.FindByUsername(Username);
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
     
        }
     


        _updatedUser = user;
        Console.WriteLine(_updatedUser.Username + "  " + Title);

        _multipleChoiceSet =
            new MultipleChoiceSet(Title, Topic, _updatedUser);
        _multipleChoiceSet.AddQuestion(new MultipleChoiceQuestion());

        _stepper++;
        _disable = true;
        Console.WriteLine(_stepper + "   stepper");
    }


    bool _correctAnswerValue;

    int _questionNumber;

    bool? _correctAnswer;

    private void SetCorrectAnswer(bool? value)
    {
        _correctAnswer = value;
    }

    private async Task delete()
    {
        if (_stepper == 1)
        {
            _disable = true;
        }
        else
        {
            _multipleChoiceSet.RemoveLastQuestion();
            _stepper--;
            _disable = false;
            Console.WriteLine(_stepper + "   stepper");
        }
    }

    private async Task done()
    {
        _multipleChoiceSet.MultipleChoiceQuestions[_counter - 1].QuestionNumber = _counter;
        _disable = false;
        Console.WriteLine(_stepper + "   stepper");
       
        if (_stepper == 1)
        {
            _disable = false;

            try
            {
                MultipleChoiceSet multipleChoiceSet = new MultipleChoiceSet(Title, Topic, _updatedUser);
                await QuestionSetsService.CreateMultipleChoiceSet(multipleChoiceSet);

                var multipleChoiceQuestion = multipleChoiceSet.GetLastQuestion();


                var multipleChoiceQuestionOptions = multipleChoiceQuestion.QuestionOptions;


                try
                {
                    
                    await QuestionSetsService.AddMultipleChoiceQuestion(new MultipleChoiceQuestion(multipleChoiceQuestion.question, multipleChoiceQuestion.Score, multipleChoiceQuestion.QuestionNumber, multipleChoiceSet));
                    foreach (var optiom in multipleChoiceQuestionOptions)
                    {
                        try
                        {
                            await QuestionSetsService.AddMultipleChoiceQuestionOption(new QuestionOption(optiom.CorrectAnswer, optiom.Answer, multipleChoiceQuestion));
                        }
                        catch (Exception e)
                        {
                            Console.WriteLine(e);
                        }
                    }
                }
                catch (Exception e)
                {
                    Console.WriteLine(e);
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e);
            }
            Console.WriteLine("sdaasda");
            _multipleChoiceSet.AddQuestion(new MultipleChoiceQuestion());
        }
        else
        {
            var multipleChoiceQuestion = _multipleChoiceSet.GetLastQuestion();


            var multipleChoiceQuestionOptions = multipleChoiceQuestion.QuestionOptions;

            _multipleChoiceSet.AddQuestion(new MultipleChoiceQuestion());
            try
            {
                await QuestionSetsService.AddMultipleChoiceQuestion(new MultipleChoiceQuestion(multipleChoiceQuestion.question, multipleChoiceQuestion.Score, multipleChoiceQuestion.QuestionNumber, _multipleChoiceSet));
                foreach (var option in multipleChoiceQuestionOptions)
                {
                    try
                    {
                        await QuestionSetsService.AddMultipleChoiceQuestionOption(new QuestionOption(option.CorrectAnswer, option.Answer, multipleChoiceQuestion));
                    }
                    catch (Exception e)
                    {
                        Console.WriteLine(e);
                    }
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e);
            }
    // Request to add MultipleChoiceQuestion
            _stepper++;
        }
        Console.WriteLine(_multipleChoiceSet.MultipleChoiceQuestions[0].QuestionNumber + "iobaniii caunter");
        Console.WriteLine(_multipleChoiceSet.Title + "   " + _multipleChoiceSet.Topic + "   " + _multipleChoiceSet.MultipleChoiceQuestions[0].question);
    }

}